# V1.1a Release Runbook

## Overview

This runbook describes the "穩健" (steady) rollout strategy for V1.1a server-only release using Cloud Run revision tags and traffic splitting.

## Pre-requisites

- [ ] All V1.1a code changes merged to main
- [ ] GCS lifecycle rules applied (see `gcs-lifecycle-rules.md`)
- [ ] Test images prepared (see Test Assets below)

## Cloud Run Configuration

- **Project**: `omakase-481015`
- **Region**: `asia-east1`
- **Service**: `omakase-api`
- **Current URL**: `https://omakase-api-fxfooop7pq-de.a.run.app`

---

## Phase 1: Staging Burn-in (Preview URL)

### 1.1 Deploy with --no-traffic

```bash
cd backend

# Deploy new revision without routing traffic
gcloud run deploy omakase-api \
  --region asia-east1 \
  --project omakase-481015 \
  --source . \
  --no-traffic \
  --tag v1-1a-preview
```

### 1.2 Get Preview URL

```bash
# The preview URL will be:
# https://v1-1a-preview---omakase-api-fxfooop7pq-de.a.run.app
```

### 1.3 Run Burn-in Tests

Use the preview URL to run test scans. Duration: **30-60 minutes minimum**.

Test scenarios:
1. Clear handwritten menu (Japanese)
2. Printed menu (Japanese)
3. Low-light / blurry image
4. Non-menu image (should fail gracefully)
5. Large menu with many items

### 1.4 Burn-in Gates (must pass before canary)

| Gate | Criteria | How to Check |
|------|----------|--------------|
| G1. Crash/5xx | 0 new 5xx errors | Cloud Run logs: `severity>=ERROR` |
| G2. Functional | All scans reach `done` | Check logs for `scan_done` entries |
| G3. Latency | `time_to_first_menu_data_ms` p95 < 30s | Check `scan_done` logs |
| G4. Traceability | All failures have `error_code` | Check `scan_error` logs |

```bash
# Check for errors in logs
gcloud logging read 'resource.type="cloud_run_revision" AND resource.labels.service_name="omakase-api" AND severity>=ERROR' \
  --project omakase-481015 \
  --limit 50 \
  --format "table(timestamp, jsonPayload.message)"

# Check scan_done logs
gcloud logging read 'resource.type="cloud_run_revision" AND jsonPayload.message=~"scan_done"' \
  --project omakase-481015 \
  --limit 20 \
  --format json
```

---

## Phase 2: Canary Rollout (Traffic Splitting)

### 2.1 Start Canary: 1% Traffic

```bash
gcloud run services update-traffic omakase-api \
  --region asia-east1 \
  --project omakase-481015 \
  --to-tags v1-1a-preview=1
```

**Wait**: 10-30 minutes. Monitor for errors.

### 2.2 Increase to 10%

```bash
gcloud run services update-traffic omakase-api \
  --region asia-east1 \
  --project omakase-481015 \
  --to-tags v1-1a-preview=10
```

**Wait**: 30-60 minutes. Monitor for errors.

### 2.3 Increase to 50%

```bash
gcloud run services update-traffic omakase-api \
  --region asia-east1 \
  --project omakase-481015 \
  --to-tags v1-1a-preview=50
```

**Wait**: 1-2 hours. Monitor for errors.

### 2.4 Full Rollout: 100%

```bash
gcloud run services update-traffic omakase-api \
  --region asia-east1 \
  --project omakase-481015 \
  --to-latest
```

---

## Monitoring During Canary

### Key Metrics to Watch

| Metric | Target | Alert Threshold |
|--------|--------|-----------------|
| S1. Success rate | > 90% | < 80% |
| S2. 5xx rate | < 1% | > 5% |
| S3. `time_to_first_menu_data_ms` p95 | < 30s | > 45s |
| S4. `done` event emission | 100% | < 95% |

### Log Queries

```bash
# Success rate (count scan_done with status=completed)
gcloud logging read 'jsonPayload.message=~"scan_done" AND jsonPayload.message=~"completed"' \
  --project omakase-481015 \
  --limit 100

# Error rate (count scan_error)
gcloud logging read 'jsonPayload.message=~"scan_error"' \
  --project omakase-481015 \
  --limit 100

# Latency check
gcloud logging read 'jsonPayload.message=~"scan_done"' \
  --project omakase-481015 \
  --limit 20 \
  --format json | jq '.[].jsonPayload.message'
```

---

## Rollback Procedure

### Immediate Rollback (if issues detected)

```bash
# Route all traffic back to previous revision
gcloud run services update-traffic omakase-api \
  --region asia-east1 \
  --project omakase-481015 \
  --to-tags v1-1a-preview=0

# Or route to latest stable revision
gcloud run services update-traffic omakase-api \
  --region asia-east1 \
  --project omakase-481015 \
  --to-latest
```

### Rollback Triggers

- 5xx rate > 5%
- Success rate drops > 10% from baseline
- `done` events stop being emitted
- Critical error codes spike (VLM_FAILED, INTERNAL_ERROR)

### Post-Rollback

1. Capture logs with `job_id`/`session_id` for failed requests
2. Root cause analysis
3. Fix and re-deploy

---

## Test Assets

Prepare the following test images before burn-in:

| ID | Description | Expected Result |
|----|-------------|-----------------|
| T1 | Clear handwritten izakaya menu | 10+ items, all translated |
| T2 | Printed sushi menu | 15+ items, all translated |
| T3 | Low-light photo | Partial success or graceful failure |
| T4 | Non-menu image (landscape) | Error: IMAGE_NOT_MENU or VLM_FAILED |
| T5 | Very large menu (30+ items) | All items extracted, may timeout on images |

---

## Post-Release Verification

After 100% rollout, verify:

- [ ] Cloud Run logs show new revision serving traffic
- [ ] `scan_done` logs include new fields (`time_to_first_menu_data_ms`, `vlm_ms`, etc.)
- [ ] Error logs include `error_code` field
- [ ] No increase in error rate compared to baseline

---

## Changelog

- 2025-12-19: Initial runbook for V1.1a release
